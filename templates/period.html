{% extends "base.html" %}

{% block main_class %}flex flex-col flex-1 px-4 pb-24 md:pb-8 md:p-8{% endblock %}

{% block content %}
<div class="flex items-center bg-surface/50 dark:bg-background-dark/50 p-4 pb-2 -mx-4 justify-between sticky top-0 z-10 backdrop-blur-sm md:bg-transparent md:dark:bg-transparent md:backdrop-blur-none md:relative md:pt-0">
    <div class="flex size-12 shrink-0 items-center justify-start md:hidden">
        <a href="{{ url_for('dashboard') }}" class="flex items-center justify-center p-0 text-text-primary dark:text-white">
            <span class="material-symbols-outlined text-2xl">west</span>
        </a>
    </div>
    <h1 class="text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center text-text-primary dark:text-white md:text-left md:text-3xl">Period Tracking</h1>
    
    <div class="flex w-12 items-center justify-end">
        </div>
    </div>

<div class="lg:grid lg:grid-cols-3 lg:gap-8 mt-4">
    
    <div class="lg:col-span-1">
        <div class="my-4 lg:my-0">
            <div class="bg-surface dark:bg-white/5 p-4 flex items-center justify-between rounded-t-lg">
                <h2 class="text-lg font-bold leading-tight text-text-primary dark:text-white">Your Cycle Stats</h2>
                <span class="material-symbols-outlined text-primary dark:text-white">query_stats</span>
            </div>
            <div class="grid grid-cols-2 gap-px bg-border-color dark:bg-border-color/20 rounded-b-lg overflow-hidden">
                <div class="bg-card-background dark:bg-card-background/5 p-4 flex flex-col items-center text-center gap-2">
                    <span class="material-symbols-outlined text-primary text-3xl">cycle</span>
                    <p class="text-sm font-normal text-text-secondary dark:text-text-secondary/80">Average Length</p>
                    <h3 class="text-base font-bold leading-tight text-text-primary dark:text-white">{{ cycle_stats.average_length }} Days</h3>
                </div>
                <div class="bg-card-background dark:bg-card-background/5 p-4 flex flex-col items-center text-center gap-2">
                    <span class="material-symbols-outlined text-primary text-3xl">calendar_month</span>
                    <p class="text-sm font-normal text-text-secondary dark:text-text-secondary/80">Last Period</p>
                    <h3 class="text-base font-bold leading-tight text-text-primary dark:text-white">{{ cycle_stats.last_period or 'N/A' }}</h3>
                </div>
                <div class="bg-card-background dark:bg-card-background/5 p-4 flex flex-col items-center text-center gap-2">
                    <span class="material-symbols-outlined text-primary text-3xl">event_upcoming</span>
                    <p class="text-sm font-normal text-text-secondary dark:text-text-secondary/80">Next Period</p>
                    <h3 class="text-base font-bold leading-tight text-text-primary dark:text-white">{{ cycle_stats.next_period or 'N/A' }}</h3>
                </div>
                <div class="bg-card-background dark:bg-card-background/5 p-4 flex flex-col items-center text-center gap-2">
                    <span class="material-symbols-outlined text-primary text-3xl fill-1">favorite</span>
                    <p class="text-sm font-normal text-text-secondary dark:text-text-secondary/80">Fertility Window</p>
                    <h3 class="text-base font-bold leading-tight text-text-primary dark:text-white">{{ cycle_stats.fertility_window or 'N/A' }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="lg:col-span-2">
        <h3 class="text-text-primary dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pt-4 pb-2 md:hidden">History</h3>
        <div class="flex flex-col pb-32">
            {% if periods %}
                {% for period in periods %}
                    <div class="flex items-center gap-4 p-4 border-b border-border-color dark:border-border-color/20">
                        <div class="flex items-center justify-center rounded-lg bg-surface dark:bg-white/5 shrink-0 size-12">
                            <span class="material-symbols-outlined text-primary dark:text-white text-3xl">water_drop</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-base font-bold leading-normal text-text-primary dark:text-white truncate">{{ period.start_date.strftime('%b %d') }} - {{ period.end_date.strftime('%b %d, %Y') }}</p>
                            <p class="text-sm font-normal leading-normal text-text-secondary dark:text-text-secondary/80 truncate">{{ period.notes or 'No notes' }}</p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editPeriod('{{ period.id }}', '{{ period.start_date.strftime('%Y-%m-%d') }}', '{{ period.end_date.strftime('%Y-%m-%d') }}', '{{ period.notes or '' }}')" class="flex size-7 items-center justify-center text-text-secondary dark:text-text-secondary/80 shrink-0">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <form action="{{ url_for('delete_period', period_id=period.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this period?')" class="inline">
                                <button type="submit" class="flex size-7 items-center justify-center text-text-secondary dark:text-text-secondary/80 shrink-0">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4 text-text-secondary dark:text-gray-400">
                    No period history yet
                </div>
            {% endif %}
        </div>
    </div>
</div>


<div id="addPeriodModal" class="fixed inset-0 bg-black/40 dark:bg-black/60 flex items-end justify-center z-30 opacity-0 pointer-events-none transition-opacity md:items-center">
    <div class="w-full bg-background-light dark:bg-background-dark rounded-t-xl p-4 pt-5 pb-6 flex flex-col md:rounded-lg md:max-w-md">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-text-primary dark:text-white">Add/Edit Period</h2>
            <button onclick="toggleAddPeriodModal()" class="text-text-secondary dark:text-text-secondary/80 size-8 rounded-full flex items-center justify-center bg-surface dark:bg-text-primary/20">
                <span class="material-symbols-outlined text-2xl">close</span>
            </button>
        </div>
        <form action="{{ url_for('add_period') }}" method="post" class="flex flex-col gap-4">
            <div>
                <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-2" for="start-date">Start Date</label>
                <input class="w-full bg-surface dark:bg-text-primary/10 border-border-color dark:border-primary/20 rounded-lg p-3 text-text-primary dark:text-white placeholder:text-text-secondary/60 focus:ring-1 focus:ring-primary focus:border-primary" id="start-date" name="start-date" type="date" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-2" for="end-date">End Date</label>
                <input class="w-full bg-surface dark:bg-text-primary/10 border-border-color dark:border-primary/20 rounded-lg p-3 text-text-primary dark:text-white placeholder:text-text-secondary/60 focus:ring-1 focus:ring-primary focus:border-primary" id="end-date" name="end-date" type="date" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-2" for="notes">Notes</label>
                <textarea class="w-full bg-surface dark:bg-text-primary/10 border-border-color dark:border-primary/20 rounded-lg p-3 text-text-primary dark:text-white placeholder:text-text-secondary/60 focus:ring-1 focus:ring-primary focus:border-primary" id="notes" name="notes" placeholder="e.g., Heavier flow, cramps..." rows="3"></textarea>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="button" onclick="toggleAddPeriodModal()" class="flex-1 h-12 px-6 border border-border-color dark:border-primary/50 text-text-primary dark:text-white font-bold rounded-full hover:bg-surface/50 dark:hover:bg-primary/10 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 h-12 px-6 bg-primary text-white font-bold rounded-full hover:bg-primary/90 transition-colors">
                    Save Period
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleAddPeriodModal(periodId = null, startDate = '', endDate = '', notes = '') {
        const modal = document.getElementById('addPeriodModal');
        const form = document.querySelector('#addPeriodModal form');
        
        if (periodId) {
            // Editing existing period
            form.action = `/update_period/${periodId}`;
            document.getElementById('start-date').value = startDate;
            document.getElementById('end-date').value = endDate;
            document.getElementById('notes').value = notes;
        } else {
            // Adding new period
            form.action = '/add_period';
            form.reset();
        }
        
        modal.classList.toggle('opacity-0');
        modal.classList.toggle('pointer-events-none');
    }
    
    function editPeriod(periodId, startDate, endDate, notes) {
        toggleAddPeriodModal(periodId, startDate, endDate, notes);
    }
</script>
{% endblock %}